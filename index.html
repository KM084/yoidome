<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>酔い軽減アプリ</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #f0f8ff;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let width, height;

    function resizeCanvas() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }

    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let circle = {
      x: window.innerWidth / 2,
      y: window.innerHeight / 2,
      radius: 30,
      vx: 0,
      vy: 0
    };

    const damping = 0.9;

    function drawCircle() {
      ctx.clearRect(0, 0, width, height);
      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
      ctx.fillStyle = "#3498db";
      ctx.fill();
    }

    function updatePosition(ax, ay) {
      circle.vx += ax;
      circle.vy += ay;
      circle.vx *= damping;
      circle.vy *= damping;
      circle.x += circle.vx;
      circle.y += circle.vy;

      if (circle.x < circle.radius || circle.x > width - circle.radius) {
        circle.vx *= -0.8;
        circle.x = Math.max(circle.radius, Math.min(circle.x, width - circle.radius));
      }
      if (circle.y < circle.radius || circle.y > height - circle.radius) {
        circle.vy *= -0.8;
        circle.y = Math.max(circle.radius, Math.min(circle.y, height - circle.radius));
      }

      drawCircle();
    }

    function rotate3dVector(x, y, z, angleX, angleY, angleZ) {
      if (angleX < 0) angleX = 360 + angleX;
      if (angleY < 0) angleY = 360 + angleY;

      const radX = angleX * Math.PI / 180;
      const radY = angleY * Math.PI / 180;
      const radZ = angleZ * Math.PI / 180;

      const matrixX = [
        [1, 0, 0],
        [0, Math.cos(radX), -Math.sin(radX)],
        [0, Math.sin(radX), Math.cos(radX)]
      ];

      const matrixY = [
        [Math.cos(radY), 0, Math.sin(radY)],
        [0, 1, 0],
        [-Math.sin(radY), 0, Math.cos(radY)]
      ];

      const matrixZ = [
        [Math.cos(radZ), -Math.sin(radZ), 0],
        [Math.sin(radZ), Math.cos(radZ), 0],
        [0, 0, 1]
      ];

      function applyMatrix(matrix, vector) {
        return [
          matrix[0][0] * vector[0] + matrix[0][1] * vector[1] + matrix[0][2] * vector[2],
          matrix[1][0] * vector[0] + matrix[1][1] * vector[1] + matrix[1][2] * vector[2],
          matrix[2][0] * vector[0] + matrix[2][1] * vector[1] + matrix[2][2] * vector[2]
        ];
      }

      let vec = applyMatrix(matrixX, [x, y, z]);
      vec = applyMatrix(matrixY, vec);
      vec = applyMatrix(matrixZ, vec);

      return { x: vec[0], y: vec[1], z: vec[2] };
    }

    let orientation = { alpha: 0, beta: 0, gamma: 0 };

    window.addEventListener("deviceorientation", (e) => {
      orientation.alpha = e.alpha || 0; // z軸
      orientation.beta = e.beta || 0;   // x軸
      orientation.gamma = e.gamma || 0; // y軸
    });

    function initMotion() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === 'granted') {
              window.addEventListener("devicemotion", handleMotion);
            } else {
              alert("加速度センサーの使用が許可されませんでした");
            }
          })
          .catch(console.error);
      } else {
        window.addEventListener("devicemotion", handleMotion);
      }
    }

    function handleMotion(event) {
      const ax = event.accelerationIncludingGravity.x || 0;
      const ay = event.accelerationIncludingGravity.y || 0;
      const az = event.accelerationIncludingGravity.z || 0;

      const rotated = rotate3dVector(ax, ay, az, orientation.beta, orientation.gamma, orientation.alpha);
      updatePosition(rotated.x, -rotated.y);
    }

    document.body.addEventListener("click", initMotion, { once: true });
    drawCircle();
  </script>
</body>
</html>
